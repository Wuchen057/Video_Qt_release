
# 3D Marker Pose Tracking & Measurement System

本仓库包含一个高精度的 3D 标记点位姿测量与轨迹跟踪系统。项目基于 OpenCV、Ceres Solver 和 Qt 开发，旨在通过圆形标记点阵列实现亚像素级的位姿解算、实时跟踪及三维运动可视化。

## 🚀 核心特性

- **高精度位姿解算**：引入“迭代修正法”解决圆形标记点的透视偏差（Perspective Bias），将重投影误差优化至 **0.3 像素** 左右。
- **高性能实时处理**：
  - 采用 **IPPE 算法** 针对平面目标优化 PnP 解算速度。
  - 通过**查表法去畸变**、**内存池化**、**多线程同步采集**等手段实现算法深度加速。
- **鲁棒的匹配逻辑**：针对对称性标记点布局，开发了**双假设检验（Hypothesis Testing）**与基于几何骨架向量的匹配算法，有效解决镜像模糊问题。
- **三维轨迹可视化**：集成 OpenGL 实现目标运动轨迹的实时 3D 绘图。
- **工业级数据记录**：支持位姿数据与重投影误差的实时导出（TXT格式），并具备视频文件处理与同步回放功能。

---

## 🛠 环境配置

项目开发环境基于 **Visual Studio + Qt 插件**。

| 依赖库 | 说明 | 配置参考 |
| :--- | :--- | :--- |
| **OpenCV** | 核心图像处理与 PnP 解算 | Release 版本库 |
| **Ceres Solver** | 姿态优化与非线性最小二乘 | [安装参考](https://www.cnblogs.com/zsgyx/p/10920418.html) |
| **Qt** | GUI 界面设计 | 安装 Qt 后需在 VS 中安装 `Qt Visual Studio Tools` |
| **OpenGL** | 3D 轨迹渲染 | [配置说明](https://zhuanlan.zhihu.com/p/283696937) |

---

## 📈 项目演进日志 (Changelog)

### 2025-12 [深度优化与鲁棒性提升]
- **12.29**: 引入 **Raptor X 扫描仪** 获取的 14 个标记点高精度三维坐标，重投影误差大幅降至 **0.3** 附近。
- **12.26**: **匹配算法重大更新**。
    - 针对对称点阵引入基于“骨架向量”的相对几何关系匹配，支持任意角度旋转。
    - 采用双假设 PnP 求解，利用“翅膀点”辅助排除镜像误解。
- **12.22**: 增加数据持久化功能，支持将位姿和重投影误差保存至 `.txt` 文件。
- **12.18**: UI 界面集成重投影误差实时显示。
- **12.15 - 12.10**: **性能优化周**。
    - **架构**: 图像采集与处理解耦，引入硬件并行抓图。
    - **内存**: 建立内存池（缓存 `gray`, `contours`, `mask` 等），消除每帧 malloc/free。
    - **算法**: 查表法去畸变（remap）、IPPE 替代普通迭代 PnP、精简轮廓筛选逻辑。
- **12.05**: 针对近距离测量，新增 **RefineCircularPointsAttributes** 函数，通过迭代修正法消除椭圆中心与圆心投影的偏差。

### 2025-11 [核心架构建立]
- **11.28**: 完成相机 A、B 的软件同步采集逻辑修改。

---

## 🔬 关键技术说明

### 1. 透视偏差修正 (Perspective Bias Correction)
在近距离测量中，圆形标记点在图像上的中心（椭圆中心）不等于圆心的投影。系统通过以下流程修正：
1. 初始 PnP 获得粗略位姿。
2. 虚拟投影：将 3D 模型投影回 2D，计算“投影圆心”与“投影椭圆中心”的偏差。
3. 反向修正：补偿原始检测点，再次进行 PnP 迭代。

### 2. 对称性与镜像模糊处理
针对 14 个标记点在 Y 轴方向对称的问题，系统不依赖绝对坐标排序，而是：
- 提取中心骨架特征。
- 生成两种旋转假设（正向/镜像）。
- 比较两组假设的重投影误差，自动选择物理真实的位姿。

---

## 📂 项目结构
- `CameraSystemApp`: UI 逻辑与相机同步调度。
- `ImageProcessor`: 亚像素边缘提取、特征点筛选（圆度、凸度、灰度离群值剔除）。
- `PoseEstimator`: PnP 求解器、透视偏差修正、双假设验证。
- `IntegratedPoseTracker`: 综合视频处理与轨迹记录。
- `Trajectory3DPlotter`: 基于 OpenGL 的 3D 轨迹绘制引擎。

---

## 📺 运行示例

<img width="960" height="510" alt="Snipaste_2025-12-29_17-08-04" src="https://github.com/user-attachments/assets/6f9e0586-a1f6-48b9-b960-33323402bb18" />

---
**Maintainer**: [Chen Wu]  
**Last Update**: 2026-01-04
